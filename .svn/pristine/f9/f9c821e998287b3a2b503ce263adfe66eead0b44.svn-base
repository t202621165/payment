package com.cypay.common.service.impl;

import java.net.InetAddress;
import java.util.Map;
import java.util.Optional;

import javax.servlet.http.HttpServletRequest;
import javax.transaction.Transactional;

import org.apache.shiro.authz.AuthorizationInfo;
import org.apache.shiro.cache.Cache;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.cache.annotation.Cacheable;
import org.springframework.stereotype.Service;

import com.alibaba.fastjson.JSONObject;
import com.cypay.common.config.InitialLoader;
import com.cypay.common.entity.SystemSet;
import com.cypay.common.entity.Token;
import com.cypay.common.enums.Edition;
import com.cypay.common.enums.PaymentType;
import com.cypay.common.repository.impl.MerchantRepository;
import com.cypay.common.repository.impl.SystemSetRepository;
import com.cypay.common.repository.impl.TokenRepository;
import com.cypay.common.shiro.realm.MyModularRealmAuthenticator;
import com.cypay.common.util.DUtil;
import com.cypay.common.vo.Result;

import cn.hutool.crypto.SecureUtil;
import cn.hutool.json.JSONUtil;
@Service
public class SystemSetService extends BaseServiceImpl<SystemSetRepository, SystemSet,SystemSet>{
	
	public static final String AES_KEY = "c34a315844944c6da979a201dac0425e";
	
	public static final String MD5_KEY = "66ee9dd09f5647fbac9d4e9eb6081fa1";
	
	@Value("${com.payment.mark}")
	private String mark;
	
	@Value("${com.payment.ssid}")
	private String ssid;
	
	@Value("${spring.datasource.url}")
	private String dbUrl;
	
	@Autowired
	private TokenRepository tokenRepository;
	
	@Autowired
	private MerchantRepository merchantRepository;
	
	@Autowired
	private MyModularRealmAuthenticator myModularRealmAuthenticator;
	
	/**
	 * 系统授权信息验证
	 * @param request
	 * @return
	 */
	public boolean oAuth(HttpServletRequest request) {
		try {
			if (Edition.current_edition == Edition.DEFAULT) {
				//获取请求域名
				String domain = request.getServerName();
				//根据域名获取IP
				InetAddress[] address = InetAddress.getAllByName(domain);
				String ip = address[0].getHostAddress();
				
				int port = request.getServerPort();
				if (port != 80) {
					ip = ip + ":" + port;
				}
				
				return this.token(ip, InitialLoader.token);
			} else {
				return Edition.current_edition.getExpiration_date() > DUtil.getNetworkTime("yyMMdd");
			}
		} catch (Exception e) {
			e.printStackTrace();
		}
		return false;
	}
	
	public boolean token(String ip, String token) {
		boolean isValid = false;
		try {
			// 获取当前网络时间
			long curr_time = DUtil.getNetworkTime("yyMMdd");
			logger.info("【授权】获取当前时间：" + DUtil.date(curr_time));
			// 对IP进行MD5签名生成AES解密密钥
			String key = SecureUtil.md5(String.format("%s@%s", ip, AES_KEY));
			// 解密token信息
			String data = SecureUtil.aes(key.getBytes()).decryptStr(token.split("\\.")[0]);
			JSONObject json = JSONObject.parseObject(data);
			Object sign = json.remove("S");
			logger.info("【授权】授权信息签名验证。");
			// token授权信息签名验证
			if (sign.equals(SecureUtil.md5(String.format("%s@@%s", json.toJSONString(), MD5_KEY)))) {
				logger.info("【授权】签名验证通过，获取授权信息！");
				// 授权时间
				long time = DUtil.parse(json.getString("D"), "yyMMdd").getTime();
				logger.info("【授权】系统授权到期时间：" + DUtil.date(time));
				if (time > curr_time) { // 检验系统过期时间
					// 商业版授权
					if ("1".equals(json.get("E"))) {
						Edition.current_edition = Edition.BUSINESS;
					} else {
						// 个人版授权
						Edition.current_edition = Edition.PERSONAL;
						// 设置个人版最大注册商户数-默认：10个
						if (json.getIntValue("N") > 0) {
							Edition.current_edition.setMax_allowed_regist_number(json.getIntValue("N"));
						} else {
							Edition.current_edition.setMax_allowed_regist_number(10);
						}
					}
					// 授权-系统到期时间
					Edition.current_edition.setExpiration_date(time);
					// 授权-充值通道
					Object gallery = json.get("G0");
					if (gallery == null) {
						gallery = json.get("G");
						Edition.current_edition.setMultiGallery(gallery != null);
					}
					oAuthGallery(gallery);
					Edition.current_edition.setOauth_gallerys(json.get("G"));
					// 授权-支付宝代付
					Edition.current_edition.setPayeeAlipay("1".equals(json.get("A")));
					// 授权-微信代付
					Edition.current_edition.setPayeeWechat("1".equals(json.get("W")));
					isValid = true;
					logger.info("【授权】授权完成-success！");
				} else {
					logger.info("【授权】系统授权已过期！");
				}
			} else {
				logger.info("【授权】签名验证未通过！");
			}
		} catch (Exception e) {}
		
		if (!isValid) {
			Edition.current_edition = Edition.DEFAULT;
			logger.info("【授权】授权信息验证未通过！");
		}
		// 清空授权
		clearCachedAuthorizationInfo();
		return isValid;
	}
	
	/**
	 * 清空所有登陆用户的授权缓存
	 */
	private void clearCachedAuthorizationInfo() {
		myModularRealmAuthenticator.getCustomRealms().forEach(r -> {
			Cache<Object, AuthorizationInfo> cache = r.getAuthorizationCache();
			if (cache != null) {
				cache.clear();
			}
		});
	}
	
	private void oAuthGallery(Object obj) {
		logger.info("【授权】加载系统授权通道！");
		InitialLoader.USABLE_GALLERY.clear();
		if ("1".equals(obj)) {
			// 添加所有未开放通道至可用通道列表
			InitialLoader.USABLE_GALLERY.addAll(PaymentType.allGalleryMark());
		} else {
			try {
				// 添加已授权通道至可用通道列表
				InitialLoader.USABLE_GALLERY.addAll(PaymentType.dynamicAuthorMark(JSONUtil.parseArray(obj).toList(Integer.class)));
			} catch (Exception e) {}
			InitialLoader.USABLE_GALLERY.addAll(PaymentType.openGalleryMark());
		}
	}
	
	public SystemSet getSystemSet(){
		return baseRepository.findAll().get(0);
	}
	
	public String findSettlementBankByMark(String mark){
		return baseRepository.findSettlementBankByMark(mark);
	}
	
	public String findSettlementBankByMark(){
		return baseRepository.findSettlementBankByMark(mark);
	}
	
	public Optional<Token> findTokenByMark(){
		return findTokenByMark(getMark());
	}
	
	public Optional<Token> findTokenByMark(String mark){
		return tokenRepository.findByMark(mark);
	}
	
	private String getMark() {
		return SecureUtil.md5(String.format("%s@iwanol@%s", ssid, dbUrl.split("\\?")[0]));
	}
	
	public String findVersionByMark(Integer type){
		if (type == 1 || type == 2)
			return baseRepository.findVersionByMark(mark);
		else if (type == 0)
			return baseRepository.findTyVersionByMark(mark);
		else
			return baseRepository.findCq3VersionByMark(mark);
	}
	
	public Boolean findIsOpenTailAmount(){
		return baseRepository.findIsOpenTailAmount(mark);
	}
	
	public int findVisitTime(){
		return baseRepository.findVisitTimeByMark(mark);
	}
	
	public int findLoginTime(){
		return baseRepository.findLoginTimeByMark(mark);
	}
	
	public int findTailAmountRatio(){
		return baseRepository.findTailAmountRatio(mark);
	}
	
	public Map<String, Object> findIpsAndLoginState(){
		return baseRepository.findIpsAndLoginState(mark);
	}

	public int updateTokenByMark(String token){
		try {
			String mark = getMark();
			Optional<Token> optional = findTokenByMark(mark);
			Token t = null;
			if (optional.isPresent()) {
				t = optional.get();
				t.setToken(token);
			} else {
				t = new Token(mark, token);
			}
			
			tokenRepository.save(t);
		} catch (Exception e) {
			return 0;
		}
		return 1;
	}
	
	public int updateVersionByMark(String version,String type){
		if (type.equals("wg"))
			return baseRepository.updateVersionByMark(version, mark);
		else if (type.equals("ty"))
			return baseRepository.updateTyVersionByMark(version,mark);
		else
			return baseRepository.updateCq3VersionByMark(version, mark);
	}
	
	public SystemSet findRegisterData(){
		return baseRepository.findRegisterData(mark);
	}
	
	public Result updateSysSet(SystemSet systemSet){
		try{
			baseRepository.save(systemSet);
			return Result.success("更新系统设置信息成功");
		}catch(Exception e){
			return Result.error("更新系统设置信息失败");
		}
	}
	
	@Transactional
	public Result updateIpsLogin(String flag,Boolean state){
		if(flag.equals("isIps")){
			int i = baseRepository.updateIsIps(state, mark);
			if ( i > 0 ){
				int j = merchantRepository.updateIsIps(state);
				if (j > 0)
					return Result.success("【已"+(state?"开启":"关闭")+"】IPS流量统计");
				else
					return Result.error("IPS流量统计状态更改失败");
			}
		}else{
			int i = baseRepository.updateIsLogin(state, mark);
			if ( i > 0 ){
				int j = merchantRepository.updateIsLogin(state);
				if (j > 0)
					return Result.success("【已"+(state?"开启":"关闭")+"】登录器统计");
				else
					return Result.error("登录器统计状态更改失败");
			}
		}
		return null;
	}
	
	/**
	 * 更新统计间隔时间
	 * @param flag 统计类型
	 * @param time 时间
	 * @return
	 */
	@Transactional
	public Result updateIntervalTime(String flag,int time){
		if (flag.equals("visit")){
			int i = baseRepository.updateVisitTime(time, mark);
			if (i > 0)
				return Result.success("流量统计间隔设置为【"+time+"分钟】统计一次");			
		}else{
			int i = baseRepository.updateLoginTime(time, mark);
			if (i > 0)
				return Result.success("登录器统计间隔设置为【"+time+"分钟】统计一次");
		}
		return Result.error();
	}
	
	public Result updateIsOpenTailAmount(Boolean state){
		int i = baseRepository.updateIsOpenTailAmount(state, mark);
		if (i > 0){
			return Result.success("订单尾额【已"+(state?"开启":"关闭")+"】");
		}
		return Result.error();
	}
	
	public Optional<SystemSet> findSystemSetByMark(){
		return baseRepository.findByMark(mark);
	}

	public Optional<SystemSet> findByMark(String mark) {
		return baseRepository.findByMark(mark);
	}

	@Cacheable(key="'webInfo'",cacheNames = "web")
	public Map<String,String> findWebInfo(){
		return baseRepository.findWebInfo(mark);
	}

	public Result updateSettlementType(Integer settlementType) {
		baseRepository.updateSettlementType(settlementType, mark);
		return Result.success("设置成功");
	}

	public Result updateRegisterState(Integer registerState) {
		baseRepository.updateRegisterState(registerState, mark);
		return Result.success("设置成功");
	}
}
